<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
    xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog 
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <changeSet id="UAR-1225-1" author="sskinner">
        <comment>
            Make BLOB's optional in order to migrate files to DocuWare.
        </comment>
        <sql>
            alter table ATTACHMENT_FILE modify(FILE_DATA null);
        </sql>
        <rollback>
            alter table ATTACHMENT_FILE modify(FILE_DATA not null);
        </rollback>
    </changeSet>

    <changeSet id="UAR-1225-2" author="sskinner">
        <comment>
            Adding table to join KC pk with new DocuWare GUID for attachment files.
        </comment>
        <sql>
            CREATE TABLE PA_PROTOCOL_DOCUWARE_T
              (
                PA_PROTOCOL_ID NUMBER(12,0),
                FILE_ID        NUMBER(22,0),
                DOCUWARE_GUID  VARCHAR2(36 BYTE),
                VER_NBR        NUMBER(8,0) DEFAULT 1,
                OBJ_ID         VARCHAR2(36 BYTE)
              );
            ALTER TABLE PA_PROTOCOL_DOCUWARE_T
              ADD CONSTRAINT PA_PROT_DOCUWARE_P1
              PRIMARY KEY (PA_PROTOCOL_ID, FILE_ID);
            ALTER TABLE PA_PROTOCOL_DOCUWARE_T
              ADD CONSTRAINT PROT_ATTCH_PROT_FK1
              FOREIGN KEY (PA_PROTOCOL_ID)
              REFERENCES PROTOCOL_ATTACHMENT_PROTOCOL (PA_PROTOCOL_ID) ENABLE;
            ALTER TABLE PA_PROTOCOL_DOCUWARE_T
              ADD CONSTRAINT ATTACHMENT_FILE_FK1
              FOREIGN KEY (FILE_ID)
              REFERENCES ATTACHMENT_FILE (FILE_ID) ENABLE;
            ALTER TABLE PA_PROTOCOL_DOCUWARE_T MODIFY (VER_NBR NOT NULL ENABLE);
            ALTER TABLE PA_PROTOCOL_DOCUWARE_T MODIFY (OBJ_ID NOT NULL ENABLE);
        </sql>
        <rollback>
            drop table PA_PROTOCOL_DOCUWARE_T;
        </rollback>
    </changeSet>

</databaseChangeLog>
